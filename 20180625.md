# 2018/06/25(mon)
## PowerShellで書いていた`func_get-HPkanshiStatus.ps1`のkotlinでの書き直し
- まず最初に必要な`function GetReqParam`の部分。Powershellではこう。
```
[Z000431] >$url    　　              =  "http://161.95.212.225:30000/HostSearch/"
[Z000431] >[system.net.httpwebrequest]$request = [system.net.webrequest]::create($url)
[Z000431] >$res = $request.getResponse()
[Z000431] >$sr  = new-object system.IO.streamReader $res.getResponseStream()
[Z000431] >$strRes = $sr.readToEnd()
[Z000431] >[xml]$strResXmlDoc =$strRes

[Z000431] >$strResXmlDoc.html.body.form.input | format-table -autosize

type   name                 id                   value
----   ----                 --                   -----
hidden __VIEWSTATE          __VIEWSTATE          o4rhi9ERe4p0rS4Da93EB5MtzfAqFi3eTEYDr/AN72T0/dsMsStFOmqZFR6vID2jPH/4jtcohLVo
hidden __VIEWSTATEGENERATOR __VIEWSTATEGENERATOR 8614890A
hidden __EVENTVALIDATION    __EVENTVALIDATION    dZDK/0GbW9Rv7+es3UNscnne+ueynp9k7UdxqRVBIbCR4mnXhj+LLzLmAuNfrPQ2hl+tb66CcwQn

[Z000431] >$params = $strResXmlDoc.html.body.form.input | ?{$_.id -match "(__VIEWSTATE|__VIEWSTATEGENERATOR|__EVENTVALIDATION)"} | select id,value
[Z000431] >$params | format-table -autosize

id                   value
--                   -----
__VIEWSTATE          o4rhi9ERe4p0rS4Da93EB5MtzfAqFi3eTEYDr/AN72T0/dsMsStFOmqZFR6vID2jPH/4jtcohLVoyhzxVjnTtKHo0Q251w4rsft9svuQm
__VIEWSTATEGENERATOR 8614890A
__EVENTVALIDATION    dZDK/0GbW9Rv7+es3UNscnne+ueynp9k7UdxqRVBIbCR4mnXhj+LLzLmAuNfrPQ2hl+tb66CcwQnGuhm/VAjUBvcXkafXVjfhz7/jn6ED

```
- つまり、必要な情報は、全部、`<input>`タグのattributeである。
- これを、kotlinでは、どうやるか。まずベタな書き方で。
```
    fun getReqParam(): String? {
        val request: Request = Request.Builder().url(url).build()
        val response : Response = client.newCall(request).execute()
        if (response.isSuccessful) {
            val xmlDoc: Document = DocumentBuilderFactory.newInstance().newDocumentBuilder().parse(response.body()?.byteStream())

            xmlDoc.documentElement.normalize()

            val ndlist: NodeList =  xmlDoc.documentElement.getElementsByTagName("input")

            if ( ndlist.length > 0 ) {
                println("count: ndlilst.length")
                (0..(ndlist.length - 1)).iterator().forEach{
                    print( "${it} : " )
                    print( "num of attribus: ${ndlist.item(it).attributes.length} : ")
                    print( "hasChild? ${ndlist.item(it).hasChildNodes()} : ")
                    print( "${(ndlist.item(it)).attributes.getNamedItem("id")} : " )
                    println( "${ndlist.item(it).attributes.getNamedItem("value")}")

                }

            } else {
                println("nodelist count less than 0")
            }
```
- 実行結果
```
count: ndlilst.length
0 : num of attribus: 4 : hasChild? false : id="__VIEWSTATE" : value="c7AUKVLXoDBXXOS3o5lkwxf3y97U40jDbd8op8Tg90efuoSIx5FaMq8Y2O6+OwrqYUpm5e/juS0zmNZB7R6wUaUHDoJwKOhQ1aXQIuLQ/HBZhwQmrjUaRiez84LuM0gN2OYSKNo8QNuS4yw0GfvVPA=="
1 : num of attribus: 4 : hasChild? false : id="__VIEWSTATEGENERATOR" : value="8614890A"
2 : num of attribus: 4 : hasChild? false : id="__EVENTVALIDATION" : value="7KyBdWCXLlEKFYCsz5GwKQZqdkeJ4OsnNXPGMTvgYx7bmtwVCazxuQqlDwWVJiO6p9oHaH6PCf6u6JmIYtN+tg1EwDFG9GAkk/Pv2bQJAPdhJVpbBlfFnbpx6V+Kbg9UNMCpXinIUNbmO1unWhNCWA=="
3 : num of attribus: 3 : hasChild? false : id="txtHostname" : null
4 : num of attribus: 4 : hasChild? false : id="btnShow" : value="表示"
```
- 次に、もすこしkotlinらしく書きなおす。
# 2018/6/26(tue)
- [okhttpでbodyにパラメタセットしてPOSTでrequestするやり方](https://tech.mokelab.com/android/libs/okhttp/post.html)。
- getReqParamでとってきたパラメータでbodyParamをつくって、これで post で request取ってくるとこまではOKだが、そこからresponse.body()をxmlとしてparseするあたりからうまく行かない。
- request.body()をHTMLとしてパースするところから。。
- 調べると、java標準のhtmlパーサは古いらしく、だめで、そのかわりに、jsoup というのがいいらしい。
# 2018/6/28(thu)
- jsoupライブラリのインストール、maven(gradle)からのオンラインでの追加はなぜかダメだったので、サイトからDLし、オフラインでそれを追加。
- DLのインストールダメだったので、一旦消して、File/ProjectStructure/Libraryで[+]ボタンで、Mavenを選んで、検索するライブラリ名に"org.jsoup"とキーインして検索して、少し古い1.10.3を選んで、追加対象のModuleに "main"を選んで、OK
- MavenのリポジトリからこのライブラリのDLが開始され、"External Library"に追加表示されたことを確認。
- そのあと、コード中に、jsoupのクラスやらを記述すると、org.jsoupのimport追加が促され、OKで、import文追加された。
- HTMLから全文を文字列として取得しそれをjsoup.Jsoup.parse()でHTMLパースし　doc.
- docを各種検索等でトラバースし、目的のコンテンツを探す。方法は[ここ](https://jsoup.org/cookbook/extracting-data/dom-navigation)
# 2018/7/6(fri)
- ktorを開始。まずは元Prjにktorの追加から。[ここ](http://ktor.io/quickstart/quickstart/intellij-idea/gradle.html)参照。build.gradle.kts(ちなみに、*.ktsとあるのは、従来build.gradleはGroovyで書かてていたので、kotlin DSLで書かれたものは、*.ktsとなっているようだ)に追記するよう書いてあるが、うまくいかないのでFile/ProjecctStructure/LibraryのGUIで追加する、という認識だったのだが。
- 上のbuild.gradle.ktsの記述で追記するとエラー。kotlin DSLの文法が少し違うみたい。[ここ](https://github.com/gradle/kotlin-dsl/tree/master/samples)のをいろいろ参考に修正して入力
- 上でbuild.gradle.kts修正しrebuild実行。ideaが長時間固まる。完了後みるとktorはPrjに入っていない（DLされていない）。いちどideaを終了し起動しなおしたら勝手にbuildプロセスが再開。ktorのDLが実行された。
- ktor RESTapiの参考[ここ](https://github.com/s1monw1/ktor_application)
- getting started helloを入力してrunしたところbuildで長時間かたまり、おわったら、きのうまでうまくいってた jsoupライブラリが「ない」と言われるエラー。buildがこわれたか？org.jsoupは、以前、build.gradleのni
書いてダメで、それコメントアウトして、ProjectStructure/Libraryで、Mavenでorg.jsoupを検索してそれを追加、それでうまく行っていたが、いま見ると、「使われていない」となっている。ktorインストールでbuild.gradle.ktsを編集しそれでインストールしたら、今度は、build.gradle.ktsが有効になって、ここに書かないとダメになったとか？
- build.gradle.ktsのコメントアウトを外して、compile org.jsoup:jsoup:1.10.3 に修正（ProjetStructure/Llibraryとバージョン番号がちょっと違っていた）、そしてbuildしたら、うまくいった（jsoupの部分が元に戻った）
- 監視statusのHashMapを、JSONにしてRESTの結果に返すために、HashMap to JSON への変換は、GSONでやる。
- その前に、そもそも、ktorでresponseにJSON返すにはどうやるのか。[ここ](https://ktor.io/samples/gson.html)参照。ここでは、GSONを使っているが、respondでJSONを返す前に、元データ（ListやHashuやdata class）をGSONでJSONに変換する処理を明示的にする、ということはせず、ktorのContentNegotiationなる機構を設定して、respond(元データ)とやると、暗黙的に（自動的に）元データがJSONに自動的に変換されるようになっている。
- そもそも、ktorのrespond()にはなにを入れてもいいのか？そのようだ。[ここ](https://ktor.io/servers/responses.html)参照。 `call.respondText()`はテキスト限定。`call.respond()`は、なんでも。後者の場合は、[Content Negotiation](https://ktor.io/servers/responses.html#content-negotiation)を参照しろとある。それによると、`Content Negotiation`でObjectを自動的にJSONに変換するようにしておいて、call.respond()に入れるオブジェクトは、HashMapとかは、だめで、事前に定義した、data classだけ、のようだ。
- Content negotiationを定義せずに、つど、返したいObjekutoをGSONでJSON文字列に変換して、それを返す場合は、変換したJSONテキストを、call.respondText()にいれて返せばいいのか？
# 2018/7/10(tue)
- ktor contentConverterでコンパイルじにこんなエラー。
```
Error:(45, 13) Kotlin: Classifier 'ContentNegotiation' does not have a companion object, and thus must be initialized here
```
- `install(contentNegotiation)`のしたに、`gson`とだけ書いたが、これが良くない？ [ここ](https://ktor.io/features/content-negotiation.html)参照。　
- No. `ContentNegotiation`が、io.ktor.features.ContentNegotiation`ではない同名の他のクラスがまちがってimportされていたから。